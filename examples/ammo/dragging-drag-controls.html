<html>
  <head>
    <title>Dragging a single object with Ammo.js</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/MozillaReality/ammo.js@8bbc0ea/builds/ammo.wasm.js"></script>
    <script src="../../dist/aframe-physics-system.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/diarmidmackenzie/aframe-drag-controls@79c77d6/index.js"></script>
    <link rel="stylesheet" href="../styles.css">
    <script>

    // Component that allows switching of an Ammo body between kinametic & dynamic
    // based on events 'kinematic' and 'dynamic' emitted on the body's entity.
    AFRAME.registerComponent('physics-type-switchable', {

      init() {
        this.el.setAttribute('ammo-body', 'type: dynamic');
        this.el.setAttribute('ammo-shape', 'fit: auto');

        this.el.addEventListener("dragstart", this.becomeKinematic.bind(this));
        this.el.addEventListener("dragend", this.becomeDynamic.bind(this));

        // There appears to be a couple of bugs / limitations in Ammo physic processing.
        // 1. If they are ever to be dynamic, bodies must be dynamic when physics starts on the scene.
        // 2. The first time a dynamic body is switched kinetic, the Ammo body in the physics system (though not the visible mesh itself) continues to be processed as a dynamic body.
        //
        // The workaround used here is to quickly switch the object from dynamic to kinematic & back to dynamic
        // on initialization.
        // This enables fully slexible switching between dynamic & kinematic as required.
        this.el.addEventListener("body-loaded", () => {
          setTimeout(() => {
            this.el.setAttribute('ammo-body', 'type:kinematic');
            this.el.setAttribute('ammo-body', 'type:dynamic');
          }, 1);
        });

        this.colorIndex = 0;
      },

      becomeDynamic() {
        console.log(`${this.el.id} becoming dynamic`);

        this.el.setAttribute('ammo-body', 'type:dynamic');

      },

      becomeKinematic() {
        console.log(`${this.el.id} becoming kinematic`);

        this.el.setAttribute('ammo-body', 'type:kinematic');

      },
    });
    </script>
  </head>
  <body>
    <div class="text-overlay">
      Basic simulation of dragging physics objects.<br>
      Objects switch from dynamic to kinematic when grabbed, to permit their movement
    </div>
        <a class="code-link"
        target="_blank"
        href="https://github.com/c-frame/aframe-physics-system/blob/master/examples/ammo/dragging.html">
        view code
    </a>
    <a-scene background="color:#8ff" debug physics="driver: ammo; debug: true; debugDrawMode: 1">
      <a-entity position="0 1.6 0"
                camera 
                drag-controls="objects: .draggable"></a-entity>
       <a-entity id="test-area" position="0 1.5 -1">
        <a-sphere id="test" color="red" radius = "0.1" position = "0.5 0.5 0"
                  physics-type-switchable
                  class="draggable">
        </a-sphere>
        <a-sphere id="test" color="green" radius = "0.1" position = "0.25 0.5 0"
                  physics-type-switchable
                  class="draggable">
        </a-sphere>
        <a-sphere id="test" color="blue" radius = "0.1" position = "0 0.5 0"
                  physics-type-switchable
                  class="draggable">
        </a-sphere>

        <a-box id="tilted-plane1"
                height = "0.1"
                color='blue'
                ammo-body="type: static" ammo-shape="fit: auto"
                position = "0.6 0 0" rotation = "0 0 45">
         </a-box>

         <a-box id="tilted-plane2"
                height = "0.1"
                color='blue'
                ammo-body="type: static" ammo-shape="fit: auto"
                position = "-0.6 0 0" rotation = "0 0 -45">
         </a-box>
       </a-entity>

     <a-box id="floor-plane"
             width = "20" height = "1" depth = "20"
             color='grey'
             ammo-body="type: static" ammo-shape="fit: auto"
             position = "0 0.5 0">
      </a-box>
    </a-scene>
  </body>
</html>
